@{
    ViewData["Title"] = "Book Now - TRAVIL";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
    <style>
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: var(--space-4) var(--space-6);
            background: rgba(10, 15, 28, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--color-border);
        }

        .header-content {
            max-width: var(--max-width);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-white);
        }

            .logo i {
                color: var(--color-gold);
            }

        .main-content {
            max-width: 1100px;
            margin: 0 auto;
            padding: 100px var(--space-6) var(--space-16);
        }

        .booking-layout {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: var(--space-8);
        }

        .package-summary {
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .package-image {
            height: 250px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .package-badges {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            display: flex;
            gap: var(--space-2);
        }

        .package-info {
            padding: var(--space-6);
        }

        .package-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-white);
            margin-bottom: var(--space-2);
        }

        .package-location {
            color: var(--color-gold);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-5);
        }

        .package-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }

        .package-detail {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-slate);
            border-radius: var(--radius-md);
        }

            .package-detail i {
                color: var(--color-gold);
                width: 20px;
                text-align: center;
            }

        .package-detail-label {
            font-size: 0.75rem;
            color: var(--color-muted);
        }

        .package-detail-value {
            font-weight: 600;
            color: var(--color-white);
        }

        .booking-form {
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            position: sticky;
            top: 100px;
        }

        .booking-header {
            padding: var(--space-5);
            border-bottom: 1px solid var(--color-border);
        }

        .booking-price {
            display: flex;
            align-items: baseline;
            gap: var(--space-2);
        }

            .booking-price .original {
                font-size: 1.125rem;
                color: var(--color-muted);
                text-decoration: line-through;
            }

            .booking-price .current {
                font-size: 2rem;
                font-weight: 700;
                color: var(--color-gold);
            }

            .booking-price .per {
                font-size: 0.875rem;
                color: var(--color-silver);
            }

        .booking-body {
            padding: var(--space-5);
        }

        .availability-status {
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-5);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

            .availability-status.available {
                background: rgba(16, 185, 129, 0.1);
                border: 1px solid var(--color-success);
            }

                .availability-status.available i {
                    color: var(--color-success);
                }

            .availability-status.sold-out {
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid var(--color-error);
            }

                .availability-status.sold-out i {
                    color: var(--color-error);
                }

            .availability-status.low {
                background: rgba(245, 158, 11, 0.1);
                border: 1px solid var(--color-warning);
            }

                .availability-status.low i {
                    color: var(--color-warning);
                }

        .availability-info h4 {
            font-weight: 600;
            color: var(--color-white);
            font-size: 0.9375rem;
        }

        .availability-info p {
            font-size: 0.8125rem;
            color: var(--color-silver);
        }

        .max-bookings-warning {
            padding: var(--space-4);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-error);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-5);
        }

            .max-bookings-warning i {
                color: var(--color-error);
                margin-right: var(--space-2);
            }

            .max-bookings-warning p {
                color: var(--color-silver);
                font-size: 0.875rem;
            }

        .waiting-list-info {
            padding: var(--space-4);
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-5);
        }

            .waiting-list-info h4 {
                color: #3b82f6;
                font-weight: 600;
                margin-bottom: var(--space-2);
            }

            .waiting-list-info p {
                color: var(--color-silver);
                font-size: 0.875rem;
            }

        .waiting-list-stats {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-3);
        }

        .waiting-list-stat {
            text-align: center;
        }

        .waiting-list-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
        }

        .waiting-list-stat-label {
            font-size: 0.6875rem;
            color: var(--color-muted);
        }

        .payment-section {
            margin-bottom: var(--space-5);
        }

            .payment-section h4 {
                font-weight: 600;
                color: var(--color-white);
                margin-bottom: var(--space-3);
                font-size: 0.9375rem;
            }

        .payment-methods {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .payment-method {
            flex: 1;
            padding: var(--space-3);
            background: var(--color-slate);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-fast);
        }

            .payment-method:hover {
                border-color: var(--color-gold);
            }

            .payment-method.active {
                border-color: var(--color-gold);
                background: rgba(212, 168, 83, 0.1);
            }

            .payment-method i {
                font-size: 1.25rem;
                margin-bottom: var(--space-1);
                display: block;
            }

            .payment-method span {
                font-size: 0.75rem;
                color: var(--color-silver);
            }

        .card-form {
            display: none;
        }

            .card-form.active {
                display: block;
            }

        .card-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-2);
            font-size: 0.9375rem;
        }

            .summary-row .label {
                color: var(--color-silver);
            }

            .summary-row .value {
                color: var(--color-white);
                font-weight: 500;
            }

            .summary-row.discount .value {
                color: var(--color-success);
            }

        .summary-total {
            display: flex;
            justify-content: space-between;
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-border);
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--space-5);
        }

            .summary-total .value {
                color: var(--color-gold);
            }

        .booking-footer {
            padding: var(--space-5);
            border-top: 1px solid var(--color-border);
        }

        .book-btn {
            width: 100%;
            padding: var(--space-4);
            font-size: 1rem;
        }

        .secure-note {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            margin-top: var(--space-4);
            font-size: 0.8125rem;
            color: var(--color-muted);
        }

            .secure-note i {
                color: var(--color-success);
            }

        .processing-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 15, 28, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

            .processing-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            .processing-overlay .spinner {
                width: 60px;
                height: 60px;
                border-width: 4px;
                margin-bottom: var(--space-5);
            }

            .processing-overlay p {
                font-size: 1.25rem;
                color: var(--color-white);
            }

        @@media (max-width: 1024px) {
            .booking-layout {
                grid-template-columns: 1fr;
            }

            .booking-form {
                position: static;
            }
        }

        @@media (max-width: 640px) {
            .package-details {
                grid-template-columns: 1fr;
            }

            .card-input-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-content">
            <a href="/" class="logo"><i class="fas fa-compass"></i> TRAVIL</a>
            <div style="display: flex; align-items: center; gap: var(--space-3); color: var(--color-silver);">
                <i class="fas fa-lock" style="color: var(--color-success);"></i>
                <span>Secure Booking</span>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="booking-layout">
            <div class="package-summary">
                <div class="package-image" id="packageImage">
                    <div class="package-badges" id="packageBadges"></div>
                </div>
                <div class="package-info">
                    <h1 class="package-title" id="packageTitle">Loading...</h1>
                    <div class="package-location" id="packageLocation"><i class="fas fa-map-marker-alt"></i> <span></span></div>
                    <div class="package-details">
                        <div class="package-detail"><i class="far fa-calendar"></i><div><div class="package-detail-label">Check-in</div><div class="package-detail-value" id="checkIn">-</div></div></div>
                        <div class="package-detail"><i class="far fa-calendar-check"></i><div><div class="package-detail-label">Check-out</div><div class="package-detail-value" id="checkOut">-</div></div></div>
                        <div class="package-detail"><i class="far fa-clock"></i><div><div class="package-detail-label">Duration</div><div class="package-detail-value" id="duration">-</div></div></div>
                        <div class="package-detail"><i class="fas fa-tag"></i><div><div class="package-detail-label">Category</div><div class="package-detail-value" id="category">-</div></div></div>
                    </div>
                </div>
            </div>

            <div class="booking-form">
                <div class="booking-header">
                    <div class="booking-price">
                        <span class="original" id="originalPrice" style="display: none;"></span>
                        <span class="current" id="currentPrice">$0</span>
                        <span class="per">/ person</span>
                    </div>
                </div>
                <div class="booking-body">
                    <div class="availability-status available" id="availabilityStatus">
                        <i class="fas fa-check-circle"></i>
                        <div class="availability-info">
                            <h4>Available</h4>
                            <p id="roomsText">Loading availability...</p>
                        </div>
                    </div>

                    <div class="max-bookings-warning" id="maxBookingsWarning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>You have reached the maximum of 3 active bookings. Complete or cancel an existing booking to make a new one.</p>
                    </div>

                    <div class="waiting-list-info" id="waitingListInfo" style="display: none;">
                        <h4><i class="fas fa-clock"></i> Join Waiting List</h4>
                        <p>This package is fully booked. Join the waiting list and we'll notify you when a spot becomes available.</p>
                        <div class="waiting-list-stats">
                            <div class="waiting-list-stat"><div class="waiting-list-stat-value" id="waitingCount">0</div><div class="waiting-list-stat-label">People Waiting</div></div>
                            <div class="waiting-list-stat"><div class="waiting-list-stat-value" id="estimatedWait">~2 weeks</div><div class="waiting-list-stat-label">Est. Wait Time</div></div>
                        </div>
                    </div>

                    <div class="payment-section" id="paymentSection">
                        <h4><i class="fas fa-credit-card" style="color: var(--color-gold); margin-right: var(--space-2);"></i> Payment Method</h4>
                        <div class="payment-methods">
                            <div class="payment-method active" onclick="selectPayment('card')"><i class="far fa-credit-card"></i><span>Card</span></div>
                            <div class="payment-method" onclick="selectPayment('paypal')"><i class="fab fa-paypal"></i><span>PayPal</span></div>
                        </div>
                        <div class="card-form active" id="cardForm">
                            <div class="form-group"><label class="form-label">Card Number</label><input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCardNumber(this)" /></div>
                            <div class="card-input-row">
                                <div class="form-group"><label class="form-label">Expiry</label><input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" maxlength="5" oninput="formatExpiry(this)" /></div>
                                <div class="form-group"><label class="form-label">CVV</label><input type="text" class="form-control" id="cvv" placeholder="123" maxlength="4" /></div>
                            </div>
                            <div class="form-group"><label class="form-label">Name on Card</label><input type="text" class="form-control" id="cardName" placeholder="JOHN DOE" style="text-transform: uppercase;" /></div>
                        </div>
                    </div>

                    <div class="summary-row"><span class="label">Package Price</span><span class="value" id="summaryPrice">$0</span></div>
                    <div class="summary-row discount" id="discountRow" style="display: none;"><span class="label">Discount</span><span class="value" id="summaryDiscount">-$0</span></div>
                    <div class="summary-row"><span class="label">Service Fee</span><span class="value">$0</span></div>
                    <div class="summary-total"><span class="label">Total</span><span class="value" id="summaryTotal">$0</span></div>
                </div>
                <div class="booking-footer">
                    <button class="btn btn-primary book-btn" id="bookBtn" onclick="processBooking()">
                        <i class="fas fa-lock"></i> <span id="bookBtnText">Confirm & Pay</span>
                    </button>
                    <div class="secure-note"><i class="fas fa-shield-alt"></i> Your payment is secure. We never store card details.</div>
                </div>
            </div>
        </div>
    </main>

    <div class="processing-overlay" id="processingOverlay">
        <div class="spinner"></div>
        <p id="processingText">Processing your booking...</p>
    </div>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage">Success!</span></div>

    <script>
        var token = localStorage.getItem('token');
        var user = localStorage.getItem('user');
        var userData = null;
        var packageData = null;
        var paymentMethod = 'card';
        var activeBookingsCount = 0;
        var categoryNames = ['Family', 'Honeymoon', 'Adventure', 'Cruise', 'Luxury', 'Budget', 'Cultural', 'Beach'];

        if (user) { try { userData = JSON.parse(user); } catch (e) {} }

        function showToast(msg, type) { type = type || 'success'; var t = document.getElementById('toast'); document.getElementById('toastMessage').textContent = msg; t.className = 'toast ' + type; t.querySelector('i').className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'; t.classList.add('show'); setTimeout(function() { t.classList.remove('show'); }, 3000); }
        function formatDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
        function calcDuration(s, e) { if (!s || !e) return 0; return Math.ceil(Math.abs(new Date(e) - new Date(s)) / 86400000); }

        function selectPayment(method) {
            paymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(function(el) { el.classList.remove('active'); });
            event.currentTarget.classList.add('active');
            document.getElementById('cardForm').classList.toggle('active', method === 'card');
        }

        function formatCardNumber(input) { var value = input.value.replace(/\D/g, ''); input.value = value.match(/.{1,4}/g)?.join(' ') || value; }
        function formatExpiry(input) { var value = input.value.replace(/\D/g, ''); if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2); input.value = value; }

        async function loadPackage() {
            var pathParts = window.location.pathname.split('/');
            var packageId = pathParts[pathParts.length - 1];
            if (!packageId || isNaN(packageId)) { window.location.href = '/packages'; return; }

            try {
                var res = await fetch('/api/packages/' + packageId);
                packageData = await res.json();
                if (packageData.data) packageData = packageData.data;
                renderPackage();

                if (token) await checkActiveBookings();
            } catch (e) { console.error('Error:', e); window.location.href = '/packages'; }
        }

        function renderPackage() {
            if (!packageData) return;
            var img = packageData.images && packageData.images.length > 0 ? (packageData.images[0].startsWith('http') ? packageData.images[0] : '/images/travel-packages/' + packageData.images[0]) : 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80';
            document.getElementById('packageImage').style.backgroundImage = 'linear-gradient(to bottom, transparent 60%, rgba(0,0,0,0.8)), url(' + img + ')';

            var badges = '';
            var cat = categoryNames[packageData.packageType] || 'Travel';
            badges += '<span class="badge badge-' + cat.toLowerCase() + '">' + cat + '</span>';
            if (packageData.discountedPrice && packageData.discountedPrice < packageData.price) {
                var discount = Math.round((1 - packageData.discountedPrice / packageData.price) * 100);
                badges += '<span class="badge badge-sale">' + discount + '% OFF</span>';
            }
            document.getElementById('packageBadges').innerHTML = badges;

            document.getElementById('packageTitle').textContent = (packageData.destination || 'Package') + ' ' + cat + ' Package';
            document.getElementById('packageLocation').querySelector('span').textContent = (packageData.destination || '') + ', ' + (packageData.country || '');
            document.getElementById('checkIn').textContent = formatDate(packageData.startDate);
            document.getElementById('checkOut').textContent = formatDate(packageData.endDate);
            document.getElementById('duration').textContent = calcDuration(packageData.startDate, packageData.endDate) + ' days';
            document.getElementById('category').textContent = cat;

            var hasDis = packageData.discountedPrice && packageData.discountedPrice < packageData.price;
            var price = hasDis ? packageData.discountedPrice : packageData.price;
            if (hasDis) { document.getElementById('originalPrice').textContent = '$' + Math.round(packageData.price); document.getElementById('originalPrice').style.display = 'inline'; }
            document.getElementById('currentPrice').textContent = '$' + Math.round(price);
            document.getElementById('summaryPrice').textContent = '$' + Math.round(packageData.price);
            if (hasDis) { document.getElementById('discountRow').style.display = 'flex'; document.getElementById('summaryDiscount').textContent = '-$' + Math.round(packageData.price - packageData.discountedPrice); }
            document.getElementById('summaryTotal').textContent = '$' + Math.round(price);

            updateAvailability();
        }

        function updateAvailability() {
            var status = document.getElementById('availabilityStatus');
            var rooms = packageData.availableRooms || 0;

            if (rooms === 0) {
                status.className = 'availability-status sold-out';
                status.innerHTML = '<i class="fas fa-times-circle"></i><div class="availability-info"><h4>Sold Out</h4><p>No rooms available</p></div>';
                document.getElementById('waitingListInfo').style.display = 'block';
                document.getElementById('paymentSection').style.display = 'none';
                document.getElementById('bookBtnText').textContent = 'Join Waiting List';
            } else if (rooms <= 3) {
                status.className = 'availability-status low';
                status.innerHTML = '<i class="fas fa-exclamation-triangle"></i><div class="availability-info"><h4>Low Availability</h4><p>Only ' + rooms + ' room' + (rooms > 1 ? 's' : '') + ' left!</p></div>';
            } else {
                status.className = 'availability-status available';
                status.innerHTML = '<i class="fas fa-check-circle"></i><div class="availability-info"><h4>Available</h4><p>' + rooms + ' rooms available</p></div>';
            }
        }

        async function checkActiveBookings() {
            try {
                var res = await fetch('/api/booking/my-bookings', { headers: { 'Authorization': 'Bearer ' + token } });
                var data = await res.json();
                var bookings = data.data || data || [];
                activeBookingsCount = bookings.filter(function(b) { return b.status !== 'Cancelled' && new Date(b.package?.startDate) > new Date(); }).length;

                if (activeBookingsCount >= 3) {
                    document.getElementById('maxBookingsWarning').style.display = 'block';
                    document.getElementById('bookBtn').disabled = true;
                    document.getElementById('bookBtnText').textContent = 'Max Bookings Reached';
                }
            } catch (e) { console.error('Error:', e); }
        }

        async function processBooking() {
            if (!token) { window.location.href = '/account/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
            if (activeBookingsCount >= 3) { showToast('You have reached the maximum of 3 active bookings', 'error'); return; }

            var isSoldOut = (packageData.availableRooms || 0) === 0;

            if (!isSoldOut && paymentMethod === 'card') {
                var cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                var expiry = document.getElementById('expiryDate').value;
                var cvv = document.getElementById('cvv').value;
                if (!cardNumber || cardNumber.length < 13) { showToast('Please enter a valid card number', 'error'); return; }
                if (!expiry || expiry.length < 5) { showToast('Please enter a valid expiry date', 'error'); return; }
                if (!cvv || cvv.length < 3) { showToast('Please enter a valid CVV', 'error'); return; }
            }

            document.getElementById('processingOverlay').classList.add('active');
            document.getElementById('processingText').textContent = isSoldOut ? 'Adding to waiting list...' : 'Processing your payment...';

            try {
                if (isSoldOut) {
                    var waitRes = await fetch('/api/waiting-list', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ packageId: packageData.packageId })
                    });
                    if (waitRes.ok) {
                        showToast('Added to waiting list! We\'ll notify you when available.');
                        setTimeout(function() { window.location.href = '/account/dashboard'; }, 2000);
                    } else { var err = await waitRes.json(); throw new Error(err.message || 'Failed to join waiting list'); }
                } else {
                    var price = packageData.discountedPrice && packageData.discountedPrice < packageData.price ? packageData.discountedPrice : packageData.price;
                    var bookRes = await fetch('/api/booking/create', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ packageId: packageData.packageId, paymentMethod: paymentMethod === 'card' ? 'CreditCard' : 'PayPal', totalPrice: price })
                    });
                    if (bookRes.ok) {
                        showToast('Booking confirmed! Check your email for details.');
                        setTimeout(function() { window.location.href = '/?booking=success'; }, 2000);
                    } else { var err = await bookRes.json(); throw new Error(err.message || 'Booking failed'); }
                }
            } catch (e) {
                document.getElementById('processingOverlay').classList.remove('active');
                showToast(e.message || 'An error occurred', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', loadPackage);
    </script>
</body>
</html>
