@{
    ViewData["Title"] = "Package Details - TRAVIL";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
    <style>
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: var(--space-4) var(--space-6);
            background: rgba(10, 15, 28, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--color-border);
        }

        .header-content {
            max-width: var(--max-width);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-white);
        }

            .logo i {
                color: var(--color-gold);
            }

        .nav-links {
            display: flex;
            gap: var(--space-8);
        }

            .nav-links a {
                color: var(--color-silver);
                font-weight: 500;
                transition: color var(--transition-fast);
            }

                .nav-links a:hover {
                    color: var(--color-gold);
                }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .main-content {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 100px var(--space-6) var(--space-16);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            font-size: 0.875rem;
            color: var(--color-silver);
        }

            .breadcrumb a {
                color: var(--color-gold);
            }

            .breadcrumb i {
                font-size: 0.75rem;
            }

        .package-hero {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: var(--space-8);
            margin-bottom: var(--space-10);
        }

        .package-gallery {
            position: relative;
        }

        .gallery-main {
            width: 100%;
            height: 450px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: var(--space-4);
        }

            .gallery-main img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .gallery-thumbs {
            display: flex;
            gap: var(--space-3);
        }

        .gallery-thumb {
            width: 100px;
            height: 70px;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
        }

            .gallery-thumb.active, .gallery-thumb:hover {
                border-color: var(--color-gold);
            }

            .gallery-thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .package-badges {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .package-badge {
            padding: var(--space-2) var(--space-4);
            font-size: 0.8125rem;
            font-weight: 600;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
        }

            .package-badge.category {
                background: var(--color-gold);
                color: var(--color-bg);
            }

            .package-badge.sale {
                background: var(--color-error);
                color: white;
            }

        .booking-card {
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            position: sticky;
            top: 100px;
        }

        .booking-price {
            display: flex;
            align-items: baseline;
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

            .booking-price .current {
                font-size: 2rem;
                font-weight: 700;
                color: var(--color-gold);
            }

            .booking-price .original {
                font-size: 1.125rem;
                color: var(--color-muted);
                text-decoration: line-through;
            }

            .booking-price .per {
                color: var(--color-silver);
            }

        .booking-info {
            display: grid;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-6);
            border-bottom: 1px solid var(--color-border);
        }

        .booking-info-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            color: var(--color-silver);
        }

            .booking-info-item i {
                width: 20px;
                color: var(--color-gold);
            }

        .room-availability {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: rgba(16, 185, 129, 0.1);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-5);
        }

            .room-availability.low {
                background: rgba(245, 158, 11, 0.1);
            }

            .room-availability.sold-out {
                background: rgba(239, 68, 68, 0.1);
            }

            .room-availability i {
                color: var(--color-success);
            }

            .room-availability.low i {
                color: var(--color-warning);
            }

            .room-availability.sold-out i {
                color: var(--color-error);
            }

        .booking-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

            .booking-actions .btn {
                width: 100%;
                padding: var(--space-4);
                font-size: 1rem;
            }

        .wishlist-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3);
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-silver);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

            .wishlist-btn:hover, .wishlist-btn.active {
                border-color: var(--color-error);
                color: var(--color-error);
            }

        .package-details {
            margin-bottom: var(--space-10);
        }

        .package-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-white);
            margin-bottom: var(--space-3);
        }

        .package-location {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--color-gold);
            font-size: 1.125rem;
            margin-bottom: var(--space-6);
        }

        .package-description {
            color: var(--color-pearl);
            line-height: 1.8;
            margin-bottom: var(--space-8);
        }

        .package-features {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
        }

            .feature-item i {
                color: var(--color-gold);
            }

        .reviews-section {
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
        }

        .reviews-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
        }

            .reviews-header h2 {
                font-size: 1.5rem;
                font-weight: 600;
                color: var(--color-white);
            }

        .reviews-summary {
            display: flex;
            align-items: center;
            gap: var(--space-6);
            padding-bottom: var(--space-6);
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--space-6);
        }

        .reviews-score {
            text-align: center;
        }

            .reviews-score .score {
                font-size: 3rem;
                font-weight: 700;
                color: var(--color-gold);
            }

            .reviews-score .stars {
                color: var(--color-gold);
                margin: var(--space-2) 0;
            }

            .reviews-score .count {
                color: var(--color-silver);
                font-size: 0.875rem;
            }

        .reviews-list {
            display: grid;
            gap: var(--space-6);
        }

        .review-card {
            padding-bottom: var(--space-6);
            border-bottom: 1px solid var(--color-border);
        }

            .review-card:last-child {
                padding-bottom: 0;
                border-bottom: none;
            }

        .review-header {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-3);
        }

        .review-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: var(--color-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-bg);
        }

        .review-author-name {
            font-weight: 600;
            color: var(--color-white);
        }

        .review-date {
            font-size: 0.8125rem;
            color: var(--color-muted);
        }

        .review-rating {
            color: var(--color-gold);
            margin-bottom: var(--space-3);
        }

        .review-text {
            color: var(--color-pearl);
            line-height: 1.7;
        }

        .user-menu {
            position: relative;
        }

        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            background: var(--color-slate);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
        }

            .user-menu-btn:hover {
                border-color: var(--color-gold);
            }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: var(--color-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-bg);
            font-size: 0.875rem;
        }

        .user-menu-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 200px;
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-fast);
        }

        .user-menu:hover .user-menu-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu-dropdown a {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            color: var(--color-silver);
            transition: all var(--transition-fast);
        }

            .user-menu-dropdown a:hover {
                background: var(--color-slate);
                color: var(--color-gold);
            }

        @@media (max-width: 1024px) {
            .package-hero {
                grid-template-columns: 1fr;
            }

            .booking-card {
                position: static;
            }
        }

        @@media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .package-title {
                font-size: 1.5rem;
            }

            .gallery-main {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-content">
            <a href="/" class="logo"><i class="fas fa-compass"></i> TRAVIL</a>
            <nav class="nav-links">
                <a href="/">Home</a>
                <a href="/packages">Packages</a>
                <a href="/#about">About</a>
                <a href="/#contact">Contact</a>
            </nav>
            <div class="header-actions" id="navAuth">
                <a href="/account/login" class="btn btn-outline">Sign In</a>
                <a href="/account/register" class="btn btn-primary">Get Started</a>
            </div>
        </div>
    </header>

    <main class="main-content">
        <nav class="breadcrumb">
            <a href="/">Home</a><i class="fas fa-chevron-right"></i>
            <a href="/packages">Packages</a><i class="fas fa-chevron-right"></i>
            <span id="breadcrumbTitle">Loading...</span>
        </nav>

        <div class="package-hero">
            <div class="package-gallery">
                <div class="gallery-main"><img id="mainImage" src="" alt="Package" /></div>
                <div class="gallery-thumbs" id="galleryThumbs"></div>
                <div class="package-badges" id="packageBadges"></div>
            </div>
            <div class="booking-card">
                <div class="booking-price" id="bookingPrice"><span class="current">$0</span><span class="per">/ person</span></div>
                <div class="booking-info" id="bookingInfo">
                    <div class="booking-info-item"><i class="far fa-calendar"></i><span id="bookingDates">Loading...</span></div>
                    <div class="booking-info-item"><i class="far fa-clock"></i><span id="bookingDuration">Loading...</span></div>
                    <div class="booking-info-item"><i class="fas fa-tag"></i><span id="bookingCategory">Loading...</span></div>
                    <div class="booking-info-item" id="ageRestrictionRow" style="display: none;"><i class="fas fa-user"></i><span id="bookingAge">-</span></div>
                </div>
                <div class="room-availability" id="roomAvailability"><i class="fas fa-check-circle"></i><span>Loading...</span></div>
                <div class="booking-actions">
                    <a href="#" id="bookNowBtn" class="btn btn-primary"><i class="fas fa-credit-card"></i> Buy Now</a>
                    <a href="#" id="addToCartBtn" class="btn btn-outline"><i class="fas fa-shopping-cart"></i> Add to Cart</a>
                    <button class="wishlist-btn" id="wishlistBtn" onclick="toggleWishlist()"><i class="far fa-heart"></i><span>Add to Wishlist</span></button>
                </div>
            </div>
        </div>

        <div class="package-details">
            <h1 class="package-title" id="packageTitle">Loading...</h1>
            <div class="package-location" id="packageLocation"><i class="fas fa-map-marker-alt"></i><span>Loading...</span></div>
            <p class="package-description" id="packageDescription">Loading package details...</p>
            <div class="package-features" id="packageFeatures"></div>
        </div>

        <div class="reviews-section">
            <div class="reviews-header"><h2>Customer Reviews</h2></div>
            <div class="reviews-summary" id="reviewsSummary"><div class="loading"><div class="spinner"></div></div></div>
            <div class="reviews-list" id="reviewsList"><div class="loading"><div class="spinner"></div><p>Loading reviews...</p></div></div>
        </div>
    </main>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage">Success!</span></div>

    <script>
        var packageId = null, packageData = null;
        var categoryNames = ['Family', 'Honeymoon', 'Adventure', 'Cruise', 'Luxury', 'Budget', 'Cultural', 'Beach'];
        var defaultImages = ['https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80','https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800&q=80','https://images.unsplash.com/photo-1506929562872-bb421503ef21?w=800&q=80'];

        function showToast(msg, type) { type = type || 'success'; var t = document.getElementById('toast'); document.getElementById('toastMessage').textContent = msg; t.className = 'toast ' + type; t.querySelector('i').className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'; t.classList.add('show'); setTimeout(function() { t.classList.remove('show'); }, 3000); }
        function formatDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
        function calcDuration(s, e) { if (!s || !e) return 0; return Math.ceil(Math.abs(new Date(e) - new Date(s)) / 86400000); }
        function renderStars(r) { var h = ''; for (var i = 1; i <= 5; i++) h += '<i class="' + (i <= r ? 'fas' : 'far') + ' fa-star"></i>'; return h; }

        function updateNav() {
            var token = localStorage.getItem('token'), user = localStorage.getItem('user'), nav = document.getElementById('navAuth');
            if (token && user) {
                try {
                    var u = JSON.parse(user), isAdmin = u.role === 0 || u.role === '0' || u.role === 'Admin', dash = isAdmin ? '/admin/dashboard' : '/account/dashboard', ini = ((u.firstName||'U')[0] + (u.lastName||'')[0]).toUpperCase();
                    nav.innerHTML = '<div class="user-menu"><div class="user-menu-btn"><div class="user-avatar">' + ini + '</div><span style="color:var(--color-pearl);font-weight:500;">' + u.firstName + '</span><i class="fas fa-chevron-down" style="color:var(--color-muted);font-size:0.75rem;"></i></div><div class="user-menu-dropdown"><a href="' + dash + '"><i class="fas fa-th-large"></i> Dashboard</a><a href="/account/bookings"><i class="fas fa-calendar-check"></i> My Bookings</a><a href="/account/wishlist"><i class="fas fa-heart"></i> Wishlist</a><a href="/account/profile"><i class="fas fa-user"></i> Profile</a><a href="#" onclick="logout(event)"><i class="fas fa-sign-out-alt"></i> Logout</a></div></div>';
                } catch (e) {}
            }
        }
        function logout(e) { e.preventDefault(); localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = '/'; }

        async function loadPackage() {
            var parts = window.location.pathname.split('/'); packageId = parts[parts.length - 1];
            if (!packageId || isNaN(packageId)) { showToast('Invalid package ID', 'error'); return; }
            try {
                var res = await fetch('/api/packages/' + packageId); if (!res.ok) throw new Error('Not found');
                packageData = await res.json(); renderPackageDetails(); loadReviews();
            } catch (e) { console.error(e); showToast('Failed to load package', 'error'); }
        }

        function renderPackageDetails() {
            var p = packageData, cat = categoryNames[p.packageType] || 'Travel', hasDis = p.discountedPrice && p.discountedPrice < p.price, price = hasDis ? p.discountedPrice : p.price, dur = calcDuration(p.startDate, p.endDate);
            document.getElementById('breadcrumbTitle').textContent = p.destination + ' ' + cat;
            document.getElementById('packageTitle').textContent = p.destination + ' ' + cat + ' Package';
            document.getElementById('packageLocation').querySelector('span').textContent = p.destination + ', ' + p.country;
            document.getElementById('packageDescription').textContent = p.description || 'Experience an unforgettable journey to ' + p.destination + '.';
            var imgs = p.images && p.images.length > 0 ? p.images : defaultImages, main = imgs[0];
            document.getElementById('mainImage').src = main.startsWith('http') ? main : '/images/travel-packages/' + main;
            var th = ''; imgs.slice(0, 4).forEach(function(img, i) { var src = img.startsWith('http') ? img : '/images/travel-packages/' + img; th += '<div class="gallery-thumb ' + (i === 0 ? 'active' : '') + '" onclick="changeImage(\'' + src + '\', this)"><img src="' + src + '" /></div>'; });
            document.getElementById('galleryThumbs').innerHTML = th;
            var bg = '<span class="package-badge category">' + cat + '</span>'; if (hasDis) bg += '<span class="package-badge sale">Sale</span>';
            document.getElementById('packageBadges').innerHTML = bg;
            var ph = hasDis ? '<span class="original">$' + Math.round(p.price) + '</span><span class="current">$' + Math.round(price) + '</span><span class="per">/ person</span>' : '<span class="current">$' + Math.round(price) + '</span><span class="per">/ person</span>';
            document.getElementById('bookingPrice').innerHTML = ph;
            document.getElementById('bookingDates').textContent = formatDate(p.startDate) + ' - ' + formatDate(p.endDate);
            document.getElementById('bookingDuration').textContent = dur + ' days / ' + (dur - 1) + ' nights';
            document.getElementById('bookingCategory').textContent = cat + ' Package';
            if (p.ageRestriction) { document.getElementById('ageRestrictionRow').style.display = 'flex'; document.getElementById('bookingAge').textContent = 'Age ' + p.ageRestriction + '+ required'; }
            var roomEl = document.getElementById('roomAvailability'), rooms = p.availableRooms || 0;
            if (rooms === 0) { roomEl.className = 'room-availability sold-out'; roomEl.innerHTML = '<i class="fas fa-times-circle"></i><span>Sold Out - Join Waiting List</span>'; }
            else if (rooms <= 3) { roomEl.className = 'room-availability low'; roomEl.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Only ' + rooms + ' room' + (rooms > 1 ? 's' : '') + ' left!</span>'; }
            else { roomEl.className = 'room-availability'; roomEl.innerHTML = '<i class="fas fa-check-circle"></i><span>' + rooms + ' rooms available</span>'; }
            document.getElementById('bookNowBtn').href = '/booking/create/' + packageId + '?direct=true';
            document.getElementById('addToCartBtn').href = '/cart/add/' + packageId;
            document.getElementById('packageFeatures').innerHTML = '<div class="feature-item"><i class="fas fa-plane"></i><span>Flights Included</span></div><div class="feature-item"><i class="fas fa-hotel"></i><span>Accommodation</span></div><div class="feature-item"><i class="fas fa-utensils"></i><span>Meals Included</span></div><div class="feature-item"><i class="fas fa-map"></i><span>Guided Tours</span></div><div class="feature-item"><i class="fas fa-bus"></i><span>Transportation</span></div><div class="feature-item"><i class="fas fa-headset"></i><span>24/7 Support</span></div>';
            document.title = p.destination + ' ' + cat + ' Package - TRAVIL';
        }

        function changeImage(src, el) { document.getElementById('mainImage').src = src; document.querySelectorAll('.gallery-thumb').forEach(function(t) { t.classList.remove('active'); }); el.classList.add('active'); }

        async function loadReviews() {
            try {
                var res = await fetch('/api/review/package/' + packageId), data = await res.json(), reviews = data.data || [];
                renderReviewsSummary(reviews); renderReviewsList(reviews);
            } catch (e) { console.error(e); document.getElementById('reviewsList').innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><p>Could not load reviews.</p></div>'; }
        }

        function renderReviewsSummary(reviews) {
            var el = document.getElementById('reviewsSummary');
            if (reviews.length === 0) { el.innerHTML = '<div class="reviews-score"><div class="score">-</div><div class="stars">' + renderStars(0) + '</div><div class="count">No reviews yet</div></div>'; return; }
            var total = reviews.reduce(function(s, r) { return s + (r.rating || 0); }, 0), avg = (total / reviews.length).toFixed(1);
            el.innerHTML = '<div class="reviews-score"><div class="score">' + avg + '</div><div class="stars">' + renderStars(Math.round(avg)) + '</div><div class="count">' + reviews.length + ' review' + (reviews.length !== 1 ? 's' : '') + '</div></div>';
        }

        function renderReviewsList(reviews) {
            var el = document.getElementById('reviewsList');
            if (reviews.length === 0) { el.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><h3>No Reviews Yet</h3><p>Be the first to review this package!</p></div>'; return; }
            var h = ''; reviews.forEach(function(r) {
                var name = r.userName || 'Anonymous', ini = name.split(' ').map(function(n) { return n[0]; }).join('').substring(0, 2).toUpperCase(), date = r.createdAt ? new Date(r.createdAt).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : '';
                h += '<div class="review-card"><div class="review-header"><div class="review-avatar">' + ini + '</div><div><div class="review-author-name">' + name + '</div><div class="review-date">' + date + '</div></div></div><div class="review-rating">' + renderStars(r.rating || 5) + '</div><p class="review-text">' + (r.comment || 'Great experience!') + '</p></div>';
            });
            el.innerHTML = h;
        }

        async function toggleWishlist() {
            var token = localStorage.getItem('token');
            if (!token) { showToast('Please login to add to wishlist', 'error'); setTimeout(function() { window.location.href = '/account/login'; }, 1500); return; }
            var btn = document.getElementById('wishlistBtn'), icon = btn.querySelector('i'), text = btn.querySelector('span'), active = btn.classList.contains('active');
            try {
                if (active) { var r = await fetch('/api/wishlist/' + packageId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); if (r.ok) { btn.classList.remove('active'); icon.className = 'far fa-heart'; text.textContent = 'Add to Wishlist'; showToast('Removed from wishlist'); } }
                else { var r = await fetch('/api/wishlist/' + packageId, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } }); if (r.ok) { btn.classList.add('active'); icon.className = 'fas fa-heart'; text.textContent = 'In Wishlist'; showToast('Added to wishlist!'); } }
            } catch (e) { showToast('Error updating wishlist', 'error'); }
        }

        document.addEventListener('DOMContentLoaded', function() { updateNav(); loadPackage(); });
    </script>
</body>
</html>
