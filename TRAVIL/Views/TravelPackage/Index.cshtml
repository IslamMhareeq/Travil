@{
    ViewData["Title"] = "Travel Packages - TRAVIL";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
    <style>
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: var(--space-4) var(--space-6);
            background: rgba(10, 15, 28, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--color-border);
        }

        .header-content {
            max-width: var(--max-width);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-white);
        }

            .logo i {
                color: var(--color-gold);
            }

        .nav-links {
            display: flex;
            gap: var(--space-8);
        }

            .nav-links a {
                color: var(--color-silver);
                font-weight: 500;
                transition: color var(--transition-fast);
            }

                .nav-links a:hover, .nav-links a.active {
                    color: var(--color-gold);
                }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .page-header {
            padding: 120px var(--space-6) var(--space-12);
            background: linear-gradient(180deg, var(--color-navy) 0%, var(--color-bg) 100%);
            text-align: center;
        }

            .page-header h1 {
                font-size: 2.5rem;
                font-weight: 700;
                color: var(--color-white);
                margin-bottom: var(--space-3);
            }

            .page-header p {
                color: var(--color-silver);
                font-size: 1.125rem;
            }

        .package-count {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: rgba(212, 168, 83, 0.15);
            border: 1px solid rgba(212, 168, 83, 0.3);
            border-radius: var(--radius-full);
            padding: var(--space-2) var(--space-4);
            color: var(--color-gold);
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: var(--space-4);
        }

        .main-content {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 var(--space-6) var(--space-16);
        }

        .filters-section {
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-6);
        }

        .filters-row {
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 2;
            min-width: 250px;
            position: relative;
        }

            .search-box i {
                position: absolute;
                left: var(--space-4);
                top: 50%;
                transform: translateY(-50%);
                color: var(--color-muted);
            }

            .search-box input {
                width: 100%;
                padding: var(--space-3) var(--space-4) var(--space-3) 44px;
                background: var(--color-slate);
                border: 1px solid var(--color-border);
                border-radius: var(--radius-md);
                color: var(--color-pearl);
                font-size: 0.9375rem;
            }

                .search-box input:focus {
                    outline: none;
                    border-color: var(--color-gold);
                }

        .filter-select {
            flex: 1;
            min-width: 150px;
            padding: var(--space-3) var(--space-4);
            background: var(--color-slate);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-pearl);
            font-size: 0.9375rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

            .filter-select:focus {
                outline: none;
                border-color: var(--color-gold);
            }

        .filter-actions {
            display: flex;
            gap: var(--space-3);
        }

        .sale-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: var(--color-slate);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-silver);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

            .sale-toggle:hover {
                border-color: var(--color-gold);
            }

            .sale-toggle.active {
                background: var(--color-error);
                border-color: var(--color-error);
                color: white;
            }

        .packages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--space-6);
        }

        .package-card {
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
        }

            .package-card:hover {
                border-color: var(--color-gold);
                transform: translateY(-4px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            }

        .package-image {
            position: relative;
            height: 220px;
            overflow: hidden;
        }

            .package-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform var(--transition-normal);
            }

        .package-card:hover .package-image img {
            transform: scale(1.05);
        }

        .package-badges {
            position: absolute;
            top: var(--space-3);
            left: var(--space-3);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .package-badge {
            padding: var(--space-1) var(--space-3);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
        }

            .package-badge.category {
                background: var(--color-gold);
                color: var(--color-bg);
            }

            .package-badge.sale {
                background: var(--color-error);
                color: white;
            }

        .package-wishlist {
            position: absolute;
            top: var(--space-3);
            right: var(--space-3);
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: var(--radius-full);
            color: var(--color-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

            .package-wishlist:hover, .package-wishlist.active {
                background: var(--color-error);
            }

        .package-content {
            padding: var(--space-5);
        }

        .package-location {
            font-size: 0.8125rem;
            color: var(--color-gold);
            margin-bottom: var(--space-2);
        }

        .package-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-white);
            margin-bottom: var(--space-3);
        }

        .package-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
            font-size: 0.8125rem;
            color: var(--color-silver);
        }

            .package-meta span {
                display: flex;
                align-items: center;
                gap: var(--space-1);
            }

        .package-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-border);
        }

        .package-price {
            display: flex;
            align-items: baseline;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

            .package-price .current {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--color-gold);
            }

            .package-price .original {
                font-size: 0.875rem;
                color: var(--color-muted);
                text-decoration: line-through;
            }

            .package-price .per {
                font-size: 0.8125rem;
                color: var(--color-silver);
            }

        .package-actions {
            display: flex;
            gap: var(--space-2);
        }

        .user-menu {
            position: relative;
        }

        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            background: var(--color-slate);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
        }

            .user-menu-btn:hover {
                border-color: var(--color-gold);
            }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: var(--color-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-bg);
            font-size: 0.875rem;
        }

        .user-menu-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 200px;
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-fast);
        }

        .user-menu:hover .user-menu-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu-dropdown a {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            color: var(--color-silver);
            transition: all var(--transition-fast);
        }

            .user-menu-dropdown a:hover {
                background: var(--color-slate);
                color: var(--color-gold);
            }

        @@media (max-width: 1024px) {
            .filters-row {
                flex-direction: column;
            }

            .search-box, .filter-select {
                width: 100%;
            }
        }

        @@media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .page-header h1 {
                font-size: 1.75rem;
            }

            .packages-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-content">
            <a href="/" class="logo"><i class="fas fa-compass"></i> TRAVIL</a>
            <nav class="nav-links">
                <a href="/">Home</a>
                <a href="/packages" class="active">Packages</a>
                <a href="/#about">About</a>
                <a href="/#contact">Contact</a>
            </nav>
            <div class="header-actions" id="navAuth">
                <a href="/account/login" class="btn btn-outline">Sign In</a>
                <a href="/account/register" class="btn btn-primary">Get Started</a>
            </div>
        </div>
    </header>

    <section class="page-header">
        <div class="container">
            <h1>Travel Packages</h1>
            <p>Discover handcrafted journeys to the world's most incredible destinations</p>
            <div class="package-count">
                <i class="fas fa-suitcase"></i>
                <span id="packageCount">Loading...</span>
            </div>
        </div>
    </section>

    <main class="main-content">
        <div class="filters-section">
            <div class="filters-row">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search by destination, country, or keyword..." oninput="filterPackages()" />
                </div>
                <select class="filter-select" id="countryFilter" onchange="filterPackages()">
                    <option value="">All Countries</option>
                </select>
                <select class="filter-select" id="categoryFilter" onchange="filterPackages()">
                    <option value="">All Categories</option>
                    <option value="0">Family</option>
                    <option value="1">Honeymoon</option>
                    <option value="2">Adventure</option>
                    <option value="3">Cruise</option>
                    <option value="4">Luxury</option>
                    <option value="5">Budget</option>
                    <option value="6">Cultural</option>
                    <option value="7">Beach</option>
                </select>
                <select class="filter-select" id="priceFilter" onchange="filterPackages()">
                    <option value="">All Prices</option>
                    <option value="0-500">Under $500</option>
                    <option value="500-1000">$500 - $1,000</option>
                    <option value="1000-2000">$1,000 - $2,000</option>
                    <option value="2000-5000">$2,000 - $5,000</option>
                    <option value="5000-999999">$5,000+</option>
                </select>
                <select class="filter-select" id="sortFilter" onchange="filterPackages()">
                    <option value="default">Sort By</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="popular">Most Popular</option>
                    <option value="date">Travel Date</option>
                </select>
                <div class="filter-actions">
                    <button class="sale-toggle" id="saleToggle" onclick="toggleSale()">
                        <i class="fas fa-tag"></i> On Sale
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="resetFilters()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
        </div>

        <div class="packages-grid" id="packagesGrid">
            <div class="loading"><div class="spinner"></div><p>Loading packages...</p></div>
        </div>

        <div class="pagination" id="pagination"></div>
    </main>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage">Success!</span></div>

    <script>
        var allPackages = [];
        var filteredPackages = [];
        var saleOnly = false;
        var currentPage = 1;
        var pageSize = 12;
        var categoryNames = ['Family', 'Honeymoon', 'Adventure', 'Cruise', 'Luxury', 'Budget', 'Cultural', 'Beach'];
        var defaultImages = [
            'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80',
            'https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800&q=80',
            'https://images.unsplash.com/photo-1506929562872-bb421503ef21?w=800&q=80',
            'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=800&q=80',
            'https://images.unsplash.com/photo-1530789253388-582c481c54b0?w=800&q=80'
        ];

        function showToast(message, type) {
            type = type || 'success';
            var toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.className = 'toast ' + type;
            toast.querySelector('i').className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function calculateDuration(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            return Math.ceil(Math.abs(new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
        }

                function getPackageImage(pkg, index) {
            // Check for images array with objects
            if (pkg.images && pkg.images.length > 0) {
                var img = pkg.images[0];
                // Handle both object format and string format
                var imageUrl = typeof img === 'object' ? (img.imageUrl || img.ImageUrl) : img;
                if (imageUrl && imageUrl.startsWith('http')) return imageUrl;
                if (imageUrl) return '/images/travel-packages/' + imageUrl;
            }
            // Check for single imageUrl property
            if (pkg.imageUrl) {
                if (pkg.imageUrl.startsWith('http')) return pkg.imageUrl;
                return '/images/travel-packages/' + pkg.imageUrl;
            }
            // Fallback to default images
            return defaultImages[index % defaultImages.length];
        }

        function updateNav() {
            var token = localStorage.getItem('token');
            var user = localStorage.getItem('user');
            var nav = document.getElementById('navAuth');

            if (token && user) {
                try {
                    var userData = JSON.parse(user);
                    var isAdmin = userData.role === 0 || userData.role === '0' || userData.role === 'Admin';
                    var dashUrl = isAdmin ? '/admin/dashboard' : '/account/dashboard';
                    var initials = ((userData.firstName || 'U')[0] + (userData.lastName || '')[0]).toUpperCase();

                    nav.innerHTML = '<div class="user-menu">' +
                        '<div class="user-menu-btn">' +
                            '<div class="user-avatar">' + initials + '</div>' +
                            '<span style="color: var(--color-pearl); font-weight: 500;">' + userData.firstName + '</span>' +
                            '<i class="fas fa-chevron-down" style="color: var(--color-muted); font-size: 0.75rem;"></i>' +
                        '</div>' +
                        '<div class="user-menu-dropdown">' +
                            '<a href="' + dashUrl + '"><i class="fas fa-th-large"></i> Dashboard</a>' +
                            '<a href="/account/bookings"><i class="fas fa-calendar-check"></i> My Bookings</a>' +
                            '<a href="/account/wishlist"><i class="fas fa-heart"></i> Wishlist</a>' +
                            '<a href="/account/profile"><i class="fas fa-user"></i> Profile</a>' +
                            '<a href="#" onclick="logout(event)"><i class="fas fa-sign-out-alt"></i> Logout</a>' +
                        '</div>' +
                    '</div>';
                } catch (e) { console.error('Error:', e); }
            }
        }

        function logout(e) {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.reload();
        }

        async function loadPackages() {
            try {
                var response = await fetch('/api/packages');
                var data = await response.json();
                allPackages = data.data || data || [];

                populateCountryFilter();
                applyUrlFilters();
                filterPackages();

                document.getElementById('packageCount').textContent = allPackages.length + ' packages available';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('packagesGrid').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load packages.</p></div>';
            }
        }

        function populateCountryFilter() {
            var countries = {};
            allPackages.forEach(function(p) { if (p.country) countries[p.country] = true; });

            var select = document.getElementById('countryFilter');
            Object.keys(countries).sort().forEach(function(country) {
                var option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                select.appendChild(option);
            });
        }

        function applyUrlFilters() {
            var params = new URLSearchParams(window.location.search);
            if (params.get('country')) document.getElementById('countryFilter').value = params.get('country');
            if (params.get('category')) document.getElementById('categoryFilter').value = params.get('category');
            if (params.get('search')) document.getElementById('searchInput').value = params.get('search');
        }

        function toggleSale() {
            saleOnly = !saleOnly;
            document.getElementById('saleToggle').classList.toggle('active', saleOnly);
            filterPackages();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('priceFilter').value = '';
            document.getElementById('sortFilter').value = 'default';
            saleOnly = false;
            document.getElementById('saleToggle').classList.remove('active');
            currentPage = 1;
            filterPackages();
        }

        function filterPackages() {
            var search = document.getElementById('searchInput').value.toLowerCase();
            var country = document.getElementById('countryFilter').value;
            var category = document.getElementById('categoryFilter').value;
            var price = document.getElementById('priceFilter').value;
            var sort = document.getElementById('sortFilter').value;

            filteredPackages = allPackages.filter(function(p) {
                var matchesSearch = !search ||
                    (p.destination && p.destination.toLowerCase().indexOf(search) >= 0) ||
                    (p.country && p.country.toLowerCase().indexOf(search) >= 0) ||
                    (p.description && p.description.toLowerCase().indexOf(search) >= 0);

                var matchesCountry = !country || p.country === country;
                var matchesCategory = !category || p.packageType === parseInt(category);

                var matchesPrice = true;
                if (price) {
                    var range = price.split('-');
                    var pkgPrice = p.discountedPrice || p.price || 0;
                    matchesPrice = pkgPrice >= parseInt(range[0]) && pkgPrice <= parseInt(range[1]);
                }

                var matchesSale = !saleOnly || (p.discountedPrice && p.discountedPrice < p.price);

                return matchesSearch && matchesCountry && matchesCategory && matchesPrice && matchesSale;
            });

            // Sort
            if (sort === 'price-low') {
                filteredPackages.sort(function(a, b) { return (a.discountedPrice || a.price) - (b.discountedPrice || b.price); });
            } else if (sort === 'price-high') {
                filteredPackages.sort(function(a, b) { return (b.discountedPrice || b.price) - (a.discountedPrice || a.price); });
            } else if (sort === 'popular') {
                filteredPackages.sort(function(a, b) { return (b.totalBookings || 0) - (a.totalBookings || 0); });
            } else if (sort === 'date') {
                filteredPackages.sort(function(a, b) { return new Date(a.startDate) - new Date(b.startDate); });
            }

            currentPage = 1;
            renderPackages();
        }

        function renderPackages() {
            var grid = document.getElementById('packagesGrid');
            var totalPages = Math.ceil(filteredPackages.length / pageSize);
            var start = (currentPage - 1) * pageSize;
            var pagePackages = filteredPackages.slice(start, start + pageSize);

            if (pagePackages.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-search"></i><h3>No Packages Found</h3><p>Try adjusting your filters</p></div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            var html = '';
            pagePackages.forEach(function(pkg, index) {
                var image = getPackageImage(pkg, start + index);
                var hasDiscount = pkg.discountedPrice && pkg.discountedPrice < pkg.price;
                var displayPrice = hasDiscount ? pkg.discountedPrice : pkg.price;
                var duration = calculateDuration(pkg.startDate, pkg.endDate);
                var categoryName = categoryNames[pkg.packageType] || 'Travel';

                html += '<div class="package-card">' +
                    '<div class="package-image">' +
                        '<img src="' + image + '" alt="' + (pkg.destination || 'Package') + '" loading="lazy" />' +
                        '<div class="package-badges">' +
                            '<span class="package-badge category">' + categoryName + '</span>' +
                            (hasDiscount ? '<span class="package-badge sale">Sale</span>' : '') +
                        '</div>' +
                        '<button class="package-wishlist" onclick="toggleWishlist(' + pkg.packageId + ', this, event)"><i class="far fa-heart"></i></button>' +
                    '</div>' +
                    '<div class="package-content">' +
                        '<div class="package-location"><i class="fas fa-map-marker-alt"></i> ' + (pkg.destination || 'Unknown') + ', ' + (pkg.country || '') + '</div>' +
                        '<div class="package-title">' + (pkg.destination || 'Travel') + ' ' + categoryName + ' Package</div>' +
                        '<div class="package-meta">' +
                            '<span><i class="far fa-calendar"></i> ' + formatDate(pkg.startDate) + ' - ' + formatDate(pkg.endDate) + '</span>' +
                            '<span><i class="far fa-clock"></i> ' + duration + ' days</span>' +
                        '</div>' +
                        '<div class="package-meta">' +
                            '<span><i class="fas fa-door-open"></i> ' + (pkg.availableRooms || 0) + ' rooms</span>' +
                            (pkg.ageRestriction ? '<span><i class="fas fa-user"></i> ' + pkg.ageRestriction + '+</span>' : '') +
                        '</div>' +
                        '<div class="package-footer">' +
                            '<div class="package-price">' +
                                (hasDiscount ? '<span class="original">$' + Math.round(pkg.price) + '</span>' : '') +
                                '<span class="current">$' + Math.round(displayPrice) + '</span>' +
                                '<span class="per">/person</span>' +
                            '</div>' +
                            '<div class="package-actions">' +
                                '<a href="/packages/' + pkg.packageId + '" class="btn btn-outline btn-sm">Details</a>' +
                                '<a href="/booking/create/' + pkg.packageId + '" class="btn btn-primary btn-sm">Book Now</a>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            grid.innerHTML = html;
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            var pagination = document.getElementById('pagination');
            if (totalPages <= 1) { pagination.innerHTML = ''; return; }

            var html = '';
            for (var i = 1; i <= totalPages; i++) {
                html += '<button class="page-btn ' + (i === currentPage ? 'active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</button>';
            }
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            renderPackages();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function toggleWishlist(packageId, button, event) {
            event.preventDefault();
            event.stopPropagation();

            var token = localStorage.getItem('token');
            if (!token) {
                showToast('Please login to add to wishlist', 'error');
                setTimeout(function() { window.location.href = '/account/login'; }, 1500);
                return;
            }

            var icon = button.querySelector('i');
            var isActive = button.classList.contains('active');

            try {
                if (isActive) {
                    var response = await fetch('/api/wishlist/' + packageId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                    if (response.ok) {
                        button.classList.remove('active');
                        icon.className = 'far fa-heart';
                        showToast('Removed from wishlist');
                    }
                } else {
                    var response = await fetch('/api/wishlist/' + packageId, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
                    if (response.ok) {
                        button.classList.add('active');
                        icon.className = 'fas fa-heart';
                        showToast('Added to wishlist!');
                    }
                }
            } catch (error) { showToast('Error updating wishlist', 'error'); }
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateNav();
            loadPackages();
        });
    </script>
</body>
</html>
