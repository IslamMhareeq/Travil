@{
    ViewData["Title"] = "Shopping Cart - TRAVEL";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
    <style>
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: var(--space-4) var(--space-6);
            background: rgba(10, 15, 28, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--color-border);
        }

        .header-content {
            max-width: var(--max-width);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-white);
        }

            .logo i {
                color: var(--color-gold);
            }

        .nav-links {
            display: flex;
            gap: var(--space-8);
        }

            .nav-links a {
                color: var(--color-silver);
                font-weight: 500;
                transition: color var(--transition-fast);
            }

                .nav-links a:hover {
                    color: var(--color-gold);
                }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .main-content {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 100px var(--space-6) var(--space-16);
        }

        .page-header {
            margin-bottom: var(--space-8);
        }

            .page-header h1 {
                font-size: 2rem;
                font-weight: 700;
                color: var(--color-white);
                margin-bottom: var(--space-2);
            }

            .page-header p {
                color: var(--color-silver);
            }

        .cart-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: var(--space-8);
        }

        .cart-items {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .cart-item {
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            display: grid;
            grid-template-columns: 140px 1fr auto;
            gap: var(--space-5);
            transition: all var(--transition-normal);
        }

            .cart-item:hover {
                border-color: var(--color-gold);
            }

        .cart-item-image {
            width: 140px;
            height: 100px;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

            .cart-item-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .cart-item-info h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-white);
            margin-bottom: var(--space-2);
        }

        .cart-item-location {
            font-size: 0.875rem;
            color: var(--color-gold);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .cart-item-meta {
            display: flex;
            gap: var(--space-4);
            font-size: 0.8125rem;
            color: var(--color-silver);
        }

            .cart-item-meta span {
                display: flex;
                align-items: center;
                gap: var(--space-1);
            }

        .cart-item-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-between;
        }

        .cart-item-price {
            text-align: right;
        }

            .cart-item-price .original {
                font-size: 0.875rem;
                color: var(--color-muted);
                text-decoration: line-through;
            }

            .cart-item-price .current {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--color-gold);
            }

        .cart-item-remove {
            background: none;
            border: none;
            color: var(--color-muted);
            cursor: pointer;
            padding: var(--space-2);
            transition: color var(--transition-fast);
        }

            .cart-item-remove:hover {
                color: var(--color-error);
            }

        .cart-summary {
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            position: sticky;
            top: 100px;
            height: fit-content;
        }

            .cart-summary h2 {
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--color-white);
                margin-bottom: var(--space-5);
                padding-bottom: var(--space-4);
                border-bottom: 1px solid var(--color-border);
            }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            font-size: 0.9375rem;
        }

            .summary-row .label {
                color: var(--color-silver);
            }

            .summary-row .value {
                color: var(--color-white);
                font-weight: 500;
            }

            .summary-row.discount .value {
                color: var(--color-success);
            }

        .summary-total {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-5);
            padding-top: var(--space-5);
            border-top: 1px solid var(--color-border);
            font-size: 1.25rem;
            font-weight: 700;
        }

            .summary-total .label {
                color: var(--color-white);
            }

            .summary-total .value {
                color: var(--color-gold);
            }

        .checkout-btn {
            width: 100%;
            margin-top: var(--space-5);
            padding: var(--space-4);
            font-size: 1rem;
        }

        .continue-shopping {
            display: block;
            text-align: center;
            margin-top: var(--space-4);
            color: var(--color-silver);
            font-size: 0.875rem;
        }

            .continue-shopping:hover {
                color: var(--color-gold);
            }

        .active-bookings-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--color-warning);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-5);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

            .active-bookings-warning i {
                color: var(--color-warning);
                font-size: 1.25rem;
            }

            .active-bookings-warning p {
                color: var(--color-silver);
                font-size: 0.875rem;
            }

            .active-bookings-warning strong {
                color: var(--color-warning);
            }

        .user-menu {
            position: relative;
        }

        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            background: var(--color-slate);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
        }

            .user-menu-btn:hover {
                border-color: var(--color-gold);
            }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: var(--color-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-bg);
            font-size: 0.875rem;
        }

        .user-menu-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 200px;
            background: var(--color-charcoal);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-fast);
        }

        .user-menu:hover .user-menu-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu-dropdown a {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            color: var(--color-silver);
            transition: all var(--transition-fast);
        }

            .user-menu-dropdown a:hover {
                background: var(--color-slate);
                color: var(--color-gold);
            }

        @@media (max-width: 1024px) {
            .cart-layout {
                grid-template-columns: 1fr;
            }

            .cart-summary {
                position: static;
            }
        }

        @@media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .cart-item {
                grid-template-columns: 100px 1fr;
            }

            .cart-item-actions {
                grid-column: 1 / -1;
                flex-direction: row;
                align-items: center;
                padding-top: var(--space-3);
                border-top: 1px solid var(--color-border);
                margin-top: var(--space-3);
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-content">
            <a href="/" class="logo"><i class="fas fa-compass"></i> TRAVIL</a>
            <nav class="nav-links">
                <a href="/">Home</a>
                <a href="/packages">Packages</a>
                <a href="/#about">About</a>
                <a href="/#contact">Contact</a>
            </nav>
            <div class="header-actions" id="navAuth">
                <a href="/account/login" class="btn btn-outline">Sign In</a>
                <a href="/account/register" class="btn btn-primary">Get Started</a>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h1><i class="fas fa-shopping-cart" style="color: var(--color-gold);"></i> Shopping Cart</h1>
            <p id="cartSubtitle">Loading your cart...</p>
        </div>

        <div class="cart-layout">
            <div class="cart-items" id="cartItems">
                <div class="loading"><div class="spinner"></div><p>Loading cart items...</p></div>
            </div>

            <div class="cart-summary">
                <h2>Order Summary</h2>
                <div id="activeBookingsWarning" class="active-bookings-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>You have <strong id="activeCount">0</strong> active booking(s). Max 3 allowed.</p>
                </div>
                <div class="summary-row"><span class="label">Subtotal</span><span class="value" id="subtotal">$0</span></div>
                <div class="summary-row discount"><span class="label">Discount</span><span class="value" id="discount">-$0</span></div>
                <div class="summary-row"><span class="label">Service Fee</span><span class="value">$0</span></div>
                <div class="summary-total"><span class="label">Total</span><span class="value" id="total">$0</span></div>
                <button class="btn btn-primary checkout-btn" id="checkoutBtn" onclick="proceedToCheckout()">
                    <i class="fas fa-lock"></i> Proceed to Checkout
                </button>
                <a href="/packages" class="continue-shopping"><i class="fas fa-arrow-left"></i> Continue Shopping</a>
            </div>
        </div>
    </main>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage">Success!</span></div>

    <script>
        var token = localStorage.getItem('token');
        var user = localStorage.getItem('user');
        var userData = null;
        var cartItems = [];
        var activeBookingsCount = 0;
        var categoryNames = ['Family', 'Honeymoon', 'Adventure', 'Cruise', 'Luxury', 'Budget', 'Cultural', 'Beach'];

        if (user) { try { userData = JSON.parse(user); } catch (e) {} }

        function showToast(msg, type) { type = type || 'success'; var t = document.getElementById('toast'); document.getElementById('toastMessage').textContent = msg; t.className = 'toast ' + type; t.querySelector('i').className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'; t.classList.add('show'); setTimeout(function() { t.classList.remove('show'); }, 3000); }
        function formatDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
        function calcDuration(s, e) { if (!s || !e) return 0; return Math.ceil(Math.abs(new Date(e) - new Date(s)) / 86400000); }

        function updateNav() {
            var nav = document.getElementById('navAuth');
            if (token && userData) {
                var isAdmin = userData.role === 0 || userData.role === '0' || userData.role === 'Admin';
                var dash = isAdmin ? '/admin/dashboard' : '/account/dashboard';
                var ini = ((userData.firstName || 'U')[0] + (userData.lastName || '')[0]).toUpperCase();
                nav.innerHTML = '<div class="user-menu"><div class="user-menu-btn"><div class="user-avatar">' + ini + '</div><span style="color:var(--color-pearl);font-weight:500;">' + userData.firstName + '</span><i class="fas fa-chevron-down" style="color:var(--color-muted);font-size:0.75rem;"></i></div><div class="user-menu-dropdown"><a href="' + dash + '"><i class="fas fa-th-large"></i> Dashboard</a><a href="/account/bookings"><i class="fas fa-calendar-check"></i> My Bookings</a><a href="/account/wishlist"><i class="fas fa-heart"></i> Wishlist</a><a href="#" onclick="logout(event)"><i class="fas fa-sign-out-alt"></i> Logout</a></div></div>';
            }
        }

        function logout(e) { e.preventDefault(); localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = '/'; }

        async function loadCart() {
            if (!token) {
                document.getElementById('cartItems').innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>Please Sign In</h3><p>You need to be logged in to view your cart.</p><a href="/account/login" class="btn btn-primary" style="margin-top: var(--space-4);">Sign In</a></div>';
                document.getElementById('cartSubtitle').textContent = 'Sign in to manage your cart';
                return;
            }

            try {
                // Load cart
                var cartRes = await fetch('/api/cart', { headers: { 'Authorization': 'Bearer ' + token } });
                var cartData = await cartRes.json();
                cartItems = cartData.data || cartData.items || cartData || [];

                // Load active bookings count
                var bookingsRes = await fetch('/api/booking/my-bookings', { headers: { 'Authorization': 'Bearer ' + token } });
                var bookingsData = await bookingsRes.json();
                var bookings = bookingsData.data || bookingsData || [];
                activeBookingsCount = bookings.filter(function(b) { return b.status !== 'Cancelled' && new Date(b.package?.startDate) > new Date(); }).length;

                if (activeBookingsCount >= 3) {
                    document.getElementById('activeBookingsWarning').style.display = 'flex';
                    document.getElementById('activeCount').textContent = activeBookingsCount;
                    document.getElementById('checkoutBtn').disabled = true;
                    document.getElementById('checkoutBtn').innerHTML = '<i class="fas fa-ban"></i> Max Bookings Reached';
                }

                renderCart();
                updateSummary();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('cartItems').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load cart</p></div>';
            }
        }

        function renderCart() {
            var el = document.getElementById('cartItems');
            document.getElementById('cartSubtitle').textContent = cartItems.length + ' item' + (cartItems.length !== 1 ? 's' : '') + ' in your cart';

            if (cartItems.length === 0) {
                el.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><h3>Your Cart is Empty</h3><p>Add some amazing travel packages!</p><a href="/packages" class="btn btn-primary" style="margin-top: var(--space-4);">Browse Packages</a></div>';
                return;
            }

            var html = '';
            cartItems.forEach(function(item) {
                var pkg = item.package || item;
                var cat = categoryNames[pkg.packageType] || 'Travel';
                var hasDis = pkg.discountedPrice && pkg.discountedPrice < pkg.price;
                var price = hasDis ? pkg.discountedPrice : pkg.price;
                var dur = calcDuration(pkg.startDate, pkg.endDate);
                var img = pkg.images && pkg.images.length > 0 ? (pkg.images[0].startsWith('http') ? pkg.images[0] : '/images/travel-packages/' + pkg.images[0]) : 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400&q=80';

                html += '<div class="cart-item" id="cart-item-' + pkg.packageId + '">' +
                    '<div class="cart-item-image"><img src="' + img + '" alt="' + (pkg.destination || 'Package') + '" /></div>' +
                    '<div class="cart-item-info">' +
                        '<h3>' + (pkg.destination || 'Travel') + ' ' + cat + ' Package</h3>' +
                        '<div class="cart-item-location"><i class="fas fa-map-marker-alt"></i> ' + (pkg.destination || '') + ', ' + (pkg.country || '') + '</div>' +
                        '<div class="cart-item-meta">' +
                            '<span><i class="far fa-calendar"></i> ' + formatDate(pkg.startDate) + ' - ' + formatDate(pkg.endDate) + '</span>' +
                            '<span><i class="far fa-clock"></i> ' + dur + ' days</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="cart-item-actions">' +
                        '<button class="cart-item-remove" onclick="removeFromCart(' + pkg.packageId + ')"><i class="fas fa-trash"></i></button>' +
                        '<div class="cart-item-price">' +
                            (hasDis ? '<div class="original">$' + Math.round(pkg.price) + '</div>' : '') +
                            '<div class="current">$' + Math.round(price) + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });
            el.innerHTML = html;
        }

        function updateSummary() {
            var subtotal = 0, discount = 0;
            cartItems.forEach(function(item) {
                var pkg = item.package || item;
                subtotal += pkg.price || 0;
                if (pkg.discountedPrice && pkg.discountedPrice < pkg.price) {
                    discount += (pkg.price - pkg.discountedPrice);
                }
            });
            document.getElementById('subtotal').textContent = '$' + Math.round(subtotal);
            document.getElementById('discount').textContent = '-$' + Math.round(discount);
            document.getElementById('total').textContent = '$' + Math.round(subtotal - discount);
        }

        async function removeFromCart(packageId) {
            try {
                var res = await fetch('/api/cart/' + packageId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) {
                    showToast('Removed from cart');
                    cartItems = cartItems.filter(function(item) { var pkg = item.package || item; return pkg.packageId !== packageId; });
                    renderCart();
                    updateSummary();
                } else {
                    showToast('Failed to remove item', 'error');
                }
            } catch (e) { showToast('Error removing item', 'error'); }
        }

        function proceedToCheckout() {
            if (!token) { window.location.href = '/account/login'; return; }
            if (cartItems.length === 0) { showToast('Your cart is empty', 'error'); return; }
            if (activeBookingsCount >= 3) { showToast('You have reached the maximum of 3 active bookings', 'error'); return; }
            window.location.href = '/checkout';
        }

        document.addEventListener('DOMContentLoaded', function() { updateNav(); loadCart(); });
    </script>
</body>
</html>
